# Phase 10 Retrospective: User Story 8 — ChromaDB Memory Integration

## What Worked Well
- TDD with mocked ChromaDB — no real ChromaDB server needed for tests
- Promise chain pattern (`.then()/.catch()`) avoids `require-await` lint issues while keeping clear control flow
- Lazy connection pattern works well: server starts cleanly even when ChromaDB is down
- `setUnavailable()` export pattern lets queries.ts signal chromadb.ts about runtime failures without circular dependencies
- All 19 US8 tests passed on first implementation attempt — clean TDD

## What Didn't Work
- Nothing significant — straightforward phase

## Workarounds & Solutions
- **ChromaDB v3 API**: `chromadb` v3.3.0 uses `ChromaClient({ path: url })` not `ChromaClient({ host, port })`
- **ChromaDB metadata primitives**: Tags must be joined as comma-separated strings — ChromaDB metadata only supports primitives (string, number, boolean)
- **QueryResult structure**: ChromaDB returns `ids[][]`, `documents[][]` etc. (double-nested arrays for batch queries) — must index `[0]` for single-query results
- **vi.mock('chromadb')**: Mock must be defined BEFORE imports — Vitest hoists `vi.mock` calls automatically

## Packages & Dependencies
- `chromadb` v3.3.0: Clean API, good TypeScript types, `getOrCreateCollection` is idempotent
- No new dependencies needed — chromadb was already installed in Phase 1

## Patterns & Code
- **Lazy reconnection**: `getCollection()` attempts reconnection when `available === false` by calling `getOrCreateCollection` again on the existing client
- **Non-async functions with Promise chains**: `initializeMemory()`, `addMemories()`, `queryMemories()` all use explicit `.then()/.catch()` chains to avoid `require-await` lint rule
- **Runtime failure propagation**: `queries.ts` catches errors and calls `setUnavailable()` to flip the chromadb.ts state, then returns degraded results

## For Next Time
- Phase was fast (~30 minutes) because ChromaDB wrapper is thin and well-specified
- Consider adding integration tests with real ChromaDB for pre-merge validation (not needed for hackathon)
