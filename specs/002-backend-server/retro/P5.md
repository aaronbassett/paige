# Phase 5 Retrospective: User Story 3 — File System Layer

## What Worked Well
- Parallel agent execution for TDD tests: 3 test agents (security, buffer-cache, diff) ran simultaneously, producing 57 tests total
- Parallel implementation agents for file-ops + buffer-cache, then tree + watcher — efficient batching
- TDD stub pattern (from P4 memory) with `_` prefixed params worked first try for lint compliance
- `validatePath` with `realpathSync` + fallback handles both existing files (symlink resolution) and not-yet-created files
- Buffer cache as a simple module-level `Map` — no class overhead, works perfectly for single-user MVP

## What Didn't Work
- First commit attempt failed due to lint errors on TDD stubs (unused params without `_` prefix)
- Second commit attempt failed due to prettier formatting on file-ops.ts — need to always run format after writing stubs
- `@types/diff` v8.0.0 is marked deprecated (still works fine)

## Workarounds & Solutions
- **TDD stubs lint compliance**: Prefix all stub params with `_` (e.g., `_filePath`, `_projectDir`) from the start
- **Prettier after writes**: Always run `pnpm format` before committing, especially after agent writes
- **Path security with symlinks**: Use `realpathSync` wrapped in try/catch — ENOENT means file doesn't exist yet, fall back to `resolve()` only
- **Prefix attack prevention**: Check `startsWith(realProjectDir + sep)` not just `startsWith(realProjectDir)` to prevent `/tmp/abc-evil` matching `/tmp/abc`

## Packages & Dependencies
- `diff` v8.0.3 — `createTwoFilesPatch(oldFile, newFile, oldContent, newContent)` for unified diffs
- `@types/diff` v8.0.0 — deprecated but functional, no replacement available
- `chokidar` — already installed, works well with `ignoreInitial: true` and `awaitWriteFinish`

## Patterns & Code
- **validatePath pattern**: `realpathSync(projectDir)` + `resolve(realProjectDir, filePath)` + `realpathSync(resolved)` with ENOENT fallback + `startsWith` check
- **Buffer cache module pattern**: Module-level `Map`, exported functions, no class — simple and testable
- **Tree scanning pattern**: `readdir({ withFileTypes: true })` + `Set<string>` for noise dirs + recursive async
- **Watcher pattern**: EventEmitter + Chokidar, non-async functions returning explicit Promises (avoids `require-await`)
- **Language detection**: Static `Record<string, string>` mapping extensions to language IDs

## For Next Time
- Always prefix TDD stub params with `_` from the start to avoid lint roundtrip
- Run `pnpm format` immediately after creating/modifying files, before any commit attempt
- Consider writing stubs + tests in a single agent call if the interface is well-defined
