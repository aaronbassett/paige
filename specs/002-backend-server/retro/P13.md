# Phase 13 Retrospective: User Story 11 — UI-Driven API Calls

## What Worked Well
- Parallel subagent execution for explain.ts and review.ts saved significant time — both implemented simultaneously
- TDD approach: 24 tests written first, all passing after implementation with minimal fixes
- Clean separation: ui-apis/ layer handles business logic, WebSocket handlers are thin wrappers (broadcast result or error)
- Existing infrastructure (callApi, schemas, broadcast, logAction) made implementation straightforward
- Stub files committed with tests prevented ESLint import resolution errors

## What Didn't Work
- Unused import `ExplainResponseData` in explain.ts stub — caught by lint-staged pre-commit hook
- Duplicate import lint error in practice-review test — `AppDatabase` on separate line from `getDatabase`
- `getKataById` didn't exist in katas.ts — test agent created the stub, implementation agent filled it in

## Workarounds & Solutions
- **phaseConnection optional→null**: API schema uses `phaseConnection?: string` (optional), but ExplainResult uses `string | null`. Convert with `response.phaseConnection ?? null`.
- **Same-constraint filtering**: `JSON.stringify(attempt.constraints)` vs `JSON.stringify([...data.activeConstraints])` for exact match comparison of constraint arrays.
- **Constraint unlocking**: Compute `maxLevel = Math.max(...allAttempts.map(a => a.level))` from ALL attempts (including new one), then filter constraints by `c.minLevel <= maxLevel && !activeConstraints.includes(c.id)`.
- **Void async pattern in handlers**: WebSocket handlers use `void handleExplainThis(...).then(...).catch(...)` — fire-and-forget async with error broadcasting.

## Packages & Dependencies
- No new dependencies — all features built on existing callApi, Zod schemas, broadcast infrastructure

## Patterns & Code
- **UI-API handler pattern**: `async function handleXxx(data: InputType, sessionId: number): Promise<ResultType>` — gets db, loads context, calls callApi, logs action, returns result. Let errors propagate.
- **WebSocket wiring pattern**: Thin handler calls ui-api function with `void fn(data, sessionId).then(broadcast).catch(broadcastError)`. No async in the handler function itself.
- **Dreyfus-aware prompt building**: Helper function that switches system prompt based on highest assessment stage. Novice → analogies/high-level. Expert → architecture/trade-offs.
- **getKataById query**: `executeTakeFirst()` returns `undefined | row`, coalesce with `?? null`, cast to `KataSpec | null`.

## For Next Time
- Create all required query functions (like getKataById) in the same commit as the stubs to avoid cross-agent discovery issues
- When tests mock multiple modules from the same package, use inline `type` keyword instead of separate import lines
