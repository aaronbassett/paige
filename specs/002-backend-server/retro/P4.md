# Phase 4 Retrospective: User Story 2 — SQLite State Management

## What Worked Well
- TDD stubs with `Promise.reject()` pattern: gives ESLint-clean type resolution while tests correctly fail at runtime
- Parallel agent execution for query modules: 3 batches of 2-3 agents each, significant time savings
- Database-init test validates all 11 tables + 15 indexes — catches migration regressions early
- Session lifecycle test covers full round-trip (create → query → update → FK integrity) in 23 tests
- Insert-then-requery pattern works reliably across all 8 query modules

## What Didn't Work
- First attempt at TDD stubs used `async function` + `throw` — ESLint `require-await` rule rejects async functions without `await`
- Parallel Write tool calls failed when one file was modified by linter between read and write — had to re-read and rewrite sequentially

## Workarounds & Solutions
- **ESLint require-await + TDD stubs**: Use `function` (non-async) returning `Promise.reject(new Error('Not implemented'))` instead of `async function` + `throw`
- **Kysely insert-then-requery**: SQLite/better-sqlite3 doesn't return full row on insert — insert → get `insertId` → `Number(result.insertId)` → selectAll by id
- **Kysely upsert pattern**: `insertInto().values().onConflict((oc) => oc.column('skill_area').doUpdateSet({...} as never))` for dreyfus_assessments
- **Kysely update guard**: Check `result.numUpdatedRows === 0n` to detect non-existent rows on update

## Packages & Dependencies
- No new dependencies needed for Phase 4
- Kysely's `executeTakeFirstOrThrow()` and `executeTakeFirst()` sufficient for all CRUD patterns

## Patterns & Code
- **Query module structure**: Each module exports input interfaces + async CRUD functions taking `AppDatabase` as first arg
- **Upsert pattern**: `onConflict().doUpdateSet()` with `as never` cast — works for UNIQUE columns
- **Partial update pattern**: Build `Record<string, unknown>` from provided fields, cast with `as never` on `.set()`
- **Select with cast**: `return gaps as KnowledgeGap[]` for array selects, `return session as Session` for single

## For Next Time
- Create TDD stubs with `Promise.reject()` from the start to avoid the `require-await` lint error
- Consider combining query module implementations into fewer, larger agent calls when patterns are repetitive
- The `.sdd/codebase/` directory still doesn't exist — consider running `/sdd:map` at some point
