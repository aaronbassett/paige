# Phase 2 Retrospective: Foundational (Blocking Prerequisites)

## What Worked Well
- Parallel agent execution for independent files (env.ts + websocket.ts + mcp.ts simultaneously)
- Data model doc provided clear enough table definitions to generate migrations without ambiguity
- TypeScript strict mode caught issues early (exactOptionalPropertyTypes compliance)
- Pre-commit hooks (eslint + prettier) maintained code quality on every commit

## What Didn't Work
- lint-staged backup race condition when two git commits run back-to-back (intermittent failure)
- Prettier formatting not always matching agent output (needed `pnpm format` before commits)

## Workarounds & Solutions
- **lint-staged race**: Simply retry the commit - the issue is transient
- **Prettier mismatches**: Run `pnpm format` after agent writes before committing
- **Kysely insert typing**: Agents used `as never` cast on `.values()` to work around strict type checking on insert values (common Kysely pattern with column types)

## Packages & Dependencies
- **kysely@0.28.11**: SqliteDialect is built-in, works well with better-sqlite3. Custom MigrationProvider needed for ESM (can't use filesystem scanning)
- **better-sqlite3@12.6.2**: WAL mode and foreign_keys pragma set immediately after connection
- No new dependencies needed for Phase 2

## Patterns & Code
- **InlineMigrationProvider**: Custom Kysely MigrationProvider that uses static imports instead of filesystem scanning - avoids ESM dynamic import issues
- **DatabaseTables interface** in domain.ts maps directly to Kysely's generic parameter
- **EventEmitter pattern** for action log -> Observer subscription decoupling
- **Model pricing table** as static Record for cost estimation

## For Next Time
- Run `pnpm format` before committing to avoid Prettier pre-commit failures
- Launch agents with explicit formatting instructions to match Prettier config
- Consider batching commits to avoid lint-staged race conditions
