# Phase 7 Retrospective: User Story 5 - WebSocket Protocol

## What Worked Well
- Parallel subagent execution for handler modules (connection, file, buffer in parallel; editor, hints, user in parallel)
- Handler module separation by domain — clean, testable, easy to understand
- Central router with Map<string, MessageHandler> pattern for dispatch
- TDD stubs for server.ts and router.ts enabled tests to compile before implementation
- noServer mode for ws library — clean /ws path filtering on HTTP upgrade

## What Didn't Work
- `await fileWatcher.start()` blocked server startup — chokidar's ready event is slow on large/restricted dirs
- Contract test `PROJECT_DIR: '/tmp'` caused EACCES errors on systemd directories in /tmp
- Buffer.from(data as ArrayBuffer).toString('utf-8') needed for WebSocket RawData (can't use String() or .toString() due to no-base-to-string lint rule)
- TDD stubs must exist before test commit or ESLint fails with unresolved imports

## Workarounds & Solutions
- **File watcher non-blocking**: Use `.then()/.catch()` instead of `await` for fileWatcher.start()
- **EACCES errors**: Added chokidar `error` event handler that swallows EACCES
- **Contract test env**: Changed from `/tmp` to dedicated `/tmp/paige-contract-tests` subdir
- **WebSocket RawData**: Cast `data as ArrayBuffer` then `Buffer.from().toString('utf-8')`
- **notImplementedHandler factory**: Returns handler that sends NOT_IMPLEMENTED error for future message types

## Packages & Dependencies
- No new dependencies needed — `ws` already installed from Phase 1
- `crypto.randomUUID()` used for connection IDs (Node.js built-in, no package needed)

## Patterns & Code
- **Handler pattern**: Each handler file has local `safeLogAction()` helper using `getDatabase()` + fire-and-forget `logAction().catch()`
- **Router pattern**: `Map<string, MessageHandler>` with sync/async handler support and centralized error catching
- **Broadcast pattern**: Module-level `clients: Map<string, WsWebSocket>` with `broadcast()` sending to all OPEN clients
- **Connection tracking**: `crypto.randomUUID()` for connectionId, stored in Map, cleaned on close
- **Message envelope**: All messages validated as `{ type: string, data: unknown }` before routing

## For Next Time
- Always make watcher/background services start non-blocking in server initialization
- Test environments should use dedicated temp directories, not shared system directories like /tmp
- Create TDD stubs alongside tests in same commit to avoid ESLint import resolution failures
