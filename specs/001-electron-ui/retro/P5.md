# Phase 5 Retrospective: File Explorer with Hint Glow

## What Worked Well
- **3-agent parallel launch** for core components (FileTree, HintManager+HintGlow, CSS) — all produced consistent code independently
- **Singleton service pattern** (from editor-state.ts) transferred cleanly to hint-manager.ts
- **Handler capture test pattern** from dashboard integration tests reused perfectly for file explorer tests
- **react-arborist** worked well as a virtualized tree with minimal configuration

## What Didn't Work
- **vscode-icons-js** only provides filename-to-SVG-name mappings, NOT actual SVG files — can't render real icons without bundling or CDN
- **HintInfo type conflict** — FileTree agent defined a local `HintInfo` with only `style`, while hint-manager agent defined a richer `HintInfo` with `intensity/stiffness/damping`. Had to reconcile manually after parallel agents completed
- **ReadonlyMap reference equality** — `hintManager.getAllHints()` returns the same Map reference after mutations, causing React to skip re-renders (Object.is check). Must create `new Map()` copies

## Workarounds & Solutions
- **vscode-icons → text-based icons**: Built an EXTENSION_ICONS map with short text glyphs (TS, PY, JS, etc.) — lightweight, no CDN dependency, matches warm Paige aesthetic
- **HintInfo reconciliation**: Had FileTree import `HintInfo` from hint-manager service instead of defining its own
- **ReadonlyMap fix**: Changed `setHints(hintManager.getAllHints())` to `setHints(new Map(hintManager.getAllHints()))` to create new references
- **react-arborist in tests**: Created a mock Tree component with `forwardRef` + `useImperativeHandle` to support the `.open()` ref API used for auto-expand
- **react-arborist tree ref**: Used `any` type for tree ref since react-arborist doesn't export a clean ref type for the imperative API

## Packages & Dependencies
- **react-arborist**: Good virtualized tree. Supports `ref.open(id)` for programmatic expand. Custom node renderer via `children` prop. No external type for Tree ref
- **vscode-icons-js**: Only useful for mapping filenames to icon names. Does NOT ship actual SVG assets. Consider removing from deps or using a different icon approach for Phase 9 polish

## Patterns & Code
- **Pure tree update helpers**: `addNode()` and `removeNode()` as exported pure functions for easy unit testing separate from hook lifecycle
- **`parentPath()` derivation**: Extract parent directory from full path for `fs:tree_update` add actions
- **useFileExplorerHints bridge pattern**: Hook subscribes to both WebSocket (for messages) AND singleton service (for React reactivity), creating `new Map`/`new Set` copies on each update
- **Auto-expand via ref**: `treeRef.current.open(path)` in useEffect keyed on `autoExpandPaths` — try/catch in case node doesn't exist yet

## For Next Time
- **Type alignment across parallel agents**: When multiple agents create types that must interoperate, define the shared types first OR explicitly state which module owns the type definition
- **Singleton service → React bridge**: Always create new collection copies (Map, Set) when passing to useState — React's Object.is check won't detect mutations to the same reference
- **Mock react-arborist early**: The real component needs DOM measurements. Plan the mock strategy upfront for integration tests
