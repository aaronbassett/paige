# Phase 2 Retrospective: Foundational (Stories 1, 2, 4)

## What Worked Well

- **Parallel agent launches**: Running 3 CSS agents in parallel for design tokens/typography/animations, then 2 background agents for AppShell + WebSocket client — significant time savings
- **CSS custom properties as single source of truth**: design-tokens.css defines all values, everything else references tokens — no magic numbers
- **Lazy state initializers in React**: Using `useState(() => window.innerWidth < threshold)` avoids the ESLint `set-state-in-effect` error and is more correct (no flash of wrong state)
- **Singleton WebSocket pattern**: Clean separation — `WebSocketClient` class for testing, `wsClient` singleton for app, `useWebSocket` hook for React components
- **80 comprehensive unit tests**: Full coverage of connection lifecycle, reconnection backoff, correlation, fire-and-forget, debounce with max-wait

## What Didn't Work

- **`WebkitAppRegion` CSS property**: TypeScript's CSSProperties type doesn't include this Electron-specific property. Works at runtime but causes type noise. Need to use `as React.CSSProperties` cast or extend the type
- **Git add from wrong working directory**: Running `git add` from `electron-ui/` subdirectory failed because paths were relative to repo root. Must always run git commands from worktree root
- **ESLint `react-hooks/set-state-in-effect` rule**: Calling setState synchronously in useEffect triggers this — even for initial state setup. Solution: use lazy initializer in useState

## Workarounds & Solutions

- **Unused destructured state**: `const [_navContext, setNavContext]` still triggers `no-unused-vars` even with underscore prefix. Fix: use `const [, setNavContext]` to skip the binding entirely
- **Unescaped entities**: React's `react/no-unescaped-entities` requires `&ldquo;`/`&rdquo;` instead of `"` in JSX text content

## Packages & Dependencies

- **framer-motion v12**: `motion.div` and `AnimatePresence` work well for view transitions and sidebar collapse. Spring presets are clean: `{ stiffness: 260, damping: 20 }` for expressive, `{ stiffness: 300, damping: 28 }` for standard
- **No new dependencies added in Phase 2** — all packages were installed in Phase 1

## Patterns & Code

- **MockWebSocket for tests**: Custom mock class with `simulateOpen()`, `simulateMessage()`, `simulateClose()` test helpers — essential since happy-dom doesn't provide WebSocket
- **Fire-and-forget classification**: Maintaining a `Set<ClientMessageType>` of high-frequency event types that resolve immediately without waiting for server response
- **Debounce with max-wait**: The `maxWait` parameter ensures continuous typing still sends updates periodically (buffer:update fires at least every 5s even during rapid editing)
- **Operation queue pattern**: Messages sent while disconnected are queued and flushed on reconnect, maintaining order and resolving promises correctly

## For Next Time

- **Run lint immediately after agent output**: Agents sometimes introduce minor lint issues (unused vars, unescaped entities). Run `npm run lint` before committing agent output
- **Always git add from worktree root**: Use absolute paths or ensure cwd is the worktree root for all git operations
- **Consider extracting CSS inline styles**: Many components use `React.CSSProperties` objects inline. As components grow, consider extracting to CSS modules or a shared styles utility
