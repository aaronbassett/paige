# Phase 4 Retrospective: Code Editor (Monaco)

## What Worked Well
- **4-batch parallel execution**: Splitting into Theme+EditorState+DecorationManager+CSS → Editor+Tabs+Explain+StatusBar → FileOps → IntegrationTest maximized concurrency while respecting dependencies
- **useSyncExternalStore for singleton services**: React-recommended way to integrate editorState with concurrent rendering safety. Stable snapshot functions avoid re-subscription on every render
- **Static EDITOR_OPTIONS constant**: Defined outside the component to avoid recreating the options object on every render — important for Monaco performance
- **Exhaustive type mapping for decorations**: `Record<DecorationKey, MonacoDecorationOptions>` pattern ensures compile-time coverage of all type×style combinations — TypeScript flags missing keys if unions expand

## What Didn't Work
- **`--accent-terracotta` token doesn't exist**: Multiple agents referenced it but the design system only has `--accent-primary`. Components used fallbacks like `var(--accent-terracotta, #d97757)` which works but is inconsistent
- **Monaco type namespace assumptions**: `editor.ISelection` doesn't exist as nested type — `ISelection` is a top-level type. Agents learned to pass primitives instead of Monaco objects at API boundaries
- **SVG color duplication in data URLs**: Squiggly underline colors are hardcoded in SVG data URLs (CSS custom properties can't interpolate inside `url()`) — fragile if colors change

## Workarounds & Solutions
- **Monaco in happy-dom tests**: Mock `@monaco-editor/react` with a `<textarea>` passthrough — `onChange` and `value` forwarded faithfully. Enables testing the full edit → dirty → save flow
- **framer-motion in tests**: Mock `motion.div` as plain `<div>` passthrough — happy-dom has no animation runtime
- **Binary file detection**: Simple heuristic checking for null bytes and high control character ratio in first 8KB — good enough for MVP
- **Deleted file sentinel**: Using magic string `__PAIGE_FILE_DELETED__` in content map rather than adding `isDeleted` to TabState entity. Pragmatic for hackathon scope

## Packages & Dependencies
- **@monaco-editor/react**: Works well as a React wrapper. `beforeMount` callback for theme registration, `onMount` for editor instance access, `path` prop for per-file models with preserved undo history
- **No new dependencies added**: All Phase 4 work uses existing packages

## Patterns & Code
- **CodeEditor naming**: Named `CodeEditor` to avoid conflict with Monaco's `Editor` default export
- **`import type * as Monaco from 'monaco-editor'`**: Full type safety for theme registration without importing Monaco at runtime (loaded by @monaco-editor/react's loader)
- **Content map separate from tab state**: Large file contents stored in `Map<string, string>` separate from `TabState[]` to avoid serializing content when React components only need tab metadata
- **Split button pattern**: Main click area + caret dropdown with upward-opening menu — reusable for Review and potentially other compound actions
- **Handler capture for integration tests**: Mock `on` to capture registered handlers, then call them in `act()` to simulate WebSocket messages

## For Next Time
- **Add `--accent-terracotta` alias**: Create CSS custom property alias in design-tokens.css to match spec terminology
- **Shared test mocks**: Extract Monaco and framer-motion mocks into `tests/setup.ts` or `tests/__mocks__/` to reduce duplication across integration tests
- **Debounced buffer:update edge case**: Current implementation only fires when dirty flag transitions — consider firing on all content changes for robustness when backend is live
