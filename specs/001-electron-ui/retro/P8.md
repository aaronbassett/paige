# Phase 8 Retrospective: Hinting System [US9]

## What Worked Well
- **Three parallel component agents**: CommentBalloon, CollapsedIcon, EditorToast all created concurrently with consistent patterns, no conflicts
- **Layered implementation**: Building components first, then hook, then service, then wiring into IDE — each layer tested independently
- **Existing patterns scaled well**: The singleton + subscribe + notify pattern from earlier services (editor-state, hint-manager) worked perfectly for review-navigation
- **Multi-handler mock pattern**: Reused from Phase 7, worked cleanly for integration tests with multiple hooks subscribing to same message types
- **CoachingOverlay single-component approach**: All rendering logic (balloon vs icon, level-based, source-based) in one overlay component made wiring simple

## What Didn't Work
- Nothing major blocked progress this phase

## Workarounds & Solutions
- **`editor` as prop value, not RefObject**: The strict `react-hooks/refs` ESLint rule forbids reading `.current` during render. Solution: pass `editor` as a prop value from parent (synced via `useState` + `onMount` callback in IDE.tsx) rather than passing the ref
- **`vi.hoisted()` for mock declarations**: Vitest 4 hoists `vi.mock()` calls, so mock function variables referenced inside factories must be declared with `vi.hoisted()` to avoid "Cannot access before initialization" errors
- **Stable mock editor in tests**: Create mock editor via `useState(() => createMockEditor())` inside test wrapper to maintain reference stability across re-renders

## Packages & Dependencies
- **@floating-ui/react**: Works well for balloon positioning. `useFloating` + `offset/flip/shift` middleware covers all cases. `FloatingArrow` component provides the pointing arrow
- **react-toastify**: Simple integration for unanchored toasts. `toastId` mapped to `messageId` enables targeted dismiss. CSS import needed for base styles, then override with custom theme

## Patterns & Code
- **Level-based rendering decision**: `source === 'explain' || source === 'observer' → always balloon; expandedIds.has(id) → always balloon; hintLevel >= 2 → balloon; else → collapsed icon` — clean priority chain
- **Review navigation as singleton service**: Keeps state separate from React tree. `startReview()` sorts by path+line, circular `next()`/`previous()`, `removeComment()` with index adjustment
- **Auto-dismiss overlap detection**: Standard interval overlap check: `editStartLine <= endLine && editEndLine >= startLine` with column boundary checks. Wired into Monaco's `onDidChangeModelContent`
- **Phase transition clear**: `phase:transition` handler in useCoachingMessages clears coaching messages + toasts + expanded IDs but review navigation (separate service) is untouched

## For Next Time
- Consider creating shared mock helpers file (`tests/helpers/mocks.ts`) since the framer-motion, floating-ui, and useWebSocket mocks are now duplicated across 3+ integration tests
- The `ensureKeyframes` pattern (CSS injection by ID) is now used in 3 components — could be extracted to a shared utility
