# Phase 7 Retrospective: Coaching Sidebar

## What Worked Well
- **6-agent parallelization**: All 6 independent components/hooks (IssueContext, HintSlider, PhaseStepper, HintIllustration, useHintLevel, useKeyboardShortcuts) built concurrently — 118 new tests, all passing on first combined validation
- **Clean component interfaces**: Well-defined prop interfaces for each sub-component made container composition straightforward
- **Framer Motion AnimatePresence for phase transitions**: Using a key derived from phase statuses (`phases.map(p => p.number:p.status).join(',')`) triggers clean remount with opacity animation on phase:transition messages

## What Didn't Work
- **SVG asset loading in tests**: `import.meta.url` for SVG paths doesn't work in happy-dom test environment — required mocking HintIllustration in integration tests
- **Timer conflicts with userEvent**: `userEvent.click` with `vi.useFakeTimers()` caused 5-second timeouts in integration tests

## Workarounds & Solutions
- **HintIllustration test mock**: Mock the entire component in integration tests to avoid SVG loading issues: `vi.mock('...HintIllustration', () => ({ HintIllustration: ({ level }) => <div data-testid="hint-illustration">Level {level}</div> }))`
- **fireEvent over userEvent with fake timers**: Use `fireEvent.click` (synchronous) instead of `userEvent.click` when tests use `vi.useFakeTimers()` — avoids timer-related timeouts
- **Multiple handlers per WebSocket type**: When both `CoachingSidebar` and `useHintLevel` register for `session:start`, integration test mock needs `Map<string, Array<handler>>` instead of flat map to invoke all handlers

## Packages & Dependencies
- No new packages added — all existing packages (framer-motion, @testing-library/react) sufficient

## Patterns & Code
- **Keyframe injection pattern**: Both PhaseStepper and HintIllustration use `ensureKeyframes()` — inject a `<style>` element by ID once, subsequent calls are no-ops. Clean pattern for CSS animations without CSS modules
- **Container + sub-component composition**: CoachingSidebar manages all WebSocket state, sub-components are pure presentational with simple prop interfaces
- **useRef for stable handlers**: useKeyboardShortcuts stores handlers in a ref so the keydown listener is registered once and never re-attached when callbacks change

## For Next Time
- Consider a shared `useSessionState` hook if more components need session:start/restore/end lifecycle — currently duplicated between CoachingSidebar and useHintLevel
- Integration tests that mix multiple WebSocket-listening hooks should always use array-based handler maps in mocks
